(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{388:function(r,t,a){r.exports=a.p+"assets/img/markdown-img-paste-20190106174604653.cac090f1.png"},558:function(r,t,a){"use strict";a.r(t);var e=a(25),i=Object(e.a)({},function(){var r=this,t=r.$createElement,e=r._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":r.$parent.slotKey}},[e("h1",{attrs:{id:"深度图解剖析-document-数据路由原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#深度图解剖析-document-数据路由原理","aria-hidden":"true"}},[r._v("#")]),r._v(" 深度图解剖析 document 数据路由原理")]),r._v(" "),e("h2",{attrs:{id:"什么是数据路由？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是数据路由？","aria-hidden":"true"}},[r._v("#")]),r._v(" 什么是数据路由？")]),r._v(" "),e("p",[r._v("我们知道，一个 index 的数据会被分为多片，每片都在一个 shard 中，\n所以一个 document ，只能存在于一个 shard 中")]),r._v(" "),e("p",[r._v("当客户端创建 document 的时候，es 此时就需要决定这个 document 存放在哪一个 shard 上。")]),r._v(" "),e("p",[r._v("这个过程，就称之为 docum routing （数据路由）")]),r._v(" "),e("h2",{attrs:{id:"路由算法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#路由算法","aria-hidden":"true"}},[r._v("#")]),r._v(" 路由算法")]),r._v(" "),e("ul",[e("li",[r._v("shard = hash(routing) % number_of_primary_shards")]),r._v(" "),e("li",[r._v("routing = "),e("code",[r._v("_id")]),r._v(" or custom routing value")])]),r._v(" "),e("p",[r._v("举个例子，一个 index 有3个 primary shard，P0，P1，P2")]),r._v(" "),e("p",[r._v("每次增删改查一个 document 的时候，都会带过来一个 routing number，\n默认就是这个 document 的 "),e("code",[r._v("_id")]),r._v("（可能是手动指定，也可能是自动生成）")]),r._v(" "),e("ul",[e("li",[e("code",[r._v("routing = _id")]),r._v("，假设 "),e("code",[r._v("_id=1")])]),r._v(" "),e("li",[r._v("hash(1) % 3 = 0; 假设 hash 值为 6")])]),r._v(" "),e("h2",{attrs:{id:"手动指定-routing"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#手动指定-routing","aria-hidden":"true"}},[r._v("#")]),r._v(" 手动指定 routing")]),r._v(" "),e("p",[r._v("默认的 routing 就是 "),e("code",[r._v("_id")])]),r._v(" "),e("p",[r._v("也可以在发送请求的时候，手动指定一个 routing value，比如说 "),e("code",[r._v("put /index/type/id?routing=user_id")])]),r._v(" "),e("p",[r._v("手动指定 routing value 是很有用的，可以保证说，某一类 document 一定被路由到一个 shard 上去，\n那么在后续进行应用级别的负载均衡，以及提升批量读取的性能的时候，是很有帮助的")]),r._v(" "),e("h2",{attrs:{id:"primary-shard-数量不可变的谜底"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#primary-shard-数量不可变的谜底","aria-hidden":"true"}},[r._v("#")]),r._v(" primary shard 数量不可变的谜底")]),r._v(" "),e("p",[r._v("路由算法限制，更改之后，那么就有部分旧数据的路由错误")]),r._v(" "),e("p",[e("img",{attrs:{src:a(388),alt:""}})])])},[],!1,null,null,null);t.default=i.exports}}]);